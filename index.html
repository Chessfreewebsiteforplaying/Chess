<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockfish với WebAssembly</title>
    <script src="stockfish.js"></script>
</head>
<body>
    <h1>Bàn Cờ Vua với Stockfish</h1>
    <button id="start-stockfish">Khởi động Stockfish</button>
    <pre id="output"></pre>

    <script>
        // Hàm kiểm tra hỗ trợ WebAssembly đa luồng
        function wasmThreadsSupported() {
            const source = Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00);
            if (typeof WebAssembly !== "object" || typeof WebAssembly.validate !== "function")
                return false;
            if (!WebAssembly.validate(source)) return false;
            if (typeof SharedArrayBuffer !== "function") return false;
            if (typeof Atomics !== "object") return false;
            const mem = new WebAssembly.Memory({ shared: true, initial: 8, maximum: 16 });
            if (!(mem.buffer instanceof SharedArrayBuffer)) return false;
            try {
                window.postMessage(mem, "*");
            } catch (e) {
                return false;
            }
            try {
                mem.grow(8);
            } catch (e) {
                return false;
            }
            return true;
        }

        const output = document.getElementById('output');
        let stockfish;

        document.getElementById('start-stockfish').onclick = function() {
            if (wasmThreadsSupported()) {
                output.textContent = "Hỗ trợ WebAssembly đa luồng. Đang khởi động Stockfish...";
                stockfish = Stockfish(); // Tạo instance Stockfish
                
                stockfish.onmessage = function(event) {
                    output.textContent += event.data + '\n'; // Hiển thị thông điệp từ Stockfish
                };
                
                stockfish.postMessage('uci'); // Gửi lệnh UCI để khởi động
            } else {
                output.textContent = "Trình duyệt không hỗ trợ WebAssembly đa luồng. Không thể khởi động Stockfish.";
            }
        };
    </script>
</body>
</html>
